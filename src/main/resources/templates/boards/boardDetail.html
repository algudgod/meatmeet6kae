<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <title>게시글 상세보기</title>

        <link rel="stylesheet" href="/css/styles.css"> <!-- 기존 스타일 적용 -->
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />

        <style>
            .form-control {
                resize: none; /* 사용자가 크기 조정 못하게 고정 */
                height: 95px; /* 입력 창 높이 설정 */
                font-size: 0.9rem; /* 텍스트 크기 */
            }
            .comment-item {
                margin-bottom: 1.2rem; /* 댓글 간 간격을 넓힘 */
            }
            .comment-item .comment-header p strong {
                font-size: 0.9rem; /* 닉네임 크기 */
                font-weight: 800; /* 중간 굵기 */
            }
            .comment-item .comment-body p {
                font-size: 0.9rem; /* 내용 크기 */
                margin-top: 0.2rem;/* 닉네임과 내용 사이 간격 추가 */
            }
            .comment-item .comment-header p {
                margin: 0; /* 기본 여백 제거 */
            }

        </style>
    </head>

    <body>
    <!-- 공통 헤더 -->
    <div th:replace="~{common/header :: header}"></div>

    <!-- 게시글 상세보기 컨테이너 -->
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-10">

                <!-- 목록, 수정, 삭제 버튼 -->
                <div class="d-flex justify-content-between align-items-center mt-3 mb-4">
                    <!-- 목록(왼쪽 정렬) -->
                    <a th:href="@{/boardList(boardCategory=${boardCategory})}" class="btn btn-sm btn-outline-secondary" style="font-size: 14px;">목록</a>
                    <!-- 수정 및 삭제 버튼(오른쪽 정렬) -->
                    <div class="d-flex align-items-center">
                        <!-- 수정  -->
                        <a th:if="${user != null and user.loginId == board.user.loginId}"
                           th:href="@{/boards/editBoardForm/{boardNo}(boardNo=${board.boardNo})}"
                           class="btn btn-sm btn-outline-secondary" style="font-size: 14px; margin-right: 5px;">수정</a>

                        <!-- 삭제: POST방식을 위해 a 태그에서 독립적인 form으로 변경 -->
                        <form th:if="${user != null and user.loginId == board.user.loginId}"
                              th:action="@{/boards/deleteBoard/{boardNo}(boardNo=${board.boardNo})}"
                              method="post"
                              onsubmit="return confirm('정말 삭제하시겠습니까?');"
                              style="display: inline;">
                            <button type="submit" class="btn btn-sm btn-outline-danger" style="font-size: 14px;">삭제</button>
                        </form>
                    </div>
                </div>

                <!-- 구분선 -->
                <hr style="border: 1px solid #888;">

                <!-- 게시판 제목 -->
                <h2 class="boardDetail-title" style="font-size: 15px" th:text="${boardCategory.boardCategoryName}"></h2>

                <!-- 게시글 제목 -->
                <h2 class="boardDetail-title" th:text="${board.title}"></h2>

                <!-- 작성자 및 작성일 -->
                <div class="text-muted mt-3 mb-4">
                    <span th:text="${board.user.nickname}"></span>
                    <span th:text="'조회 ' + ${board.viewCount}" style="margin-left: 10px;"></span>
                    <span th:text="${#temporals.format(board.createDate, 'yyyy-MM-dd HH:mm')}" style="margin-left: 10px;"></span>
                </div>

                <!-- 구분선 -->
                <hr style="border: 1px solid #888;">

                <!-- 게시글 내용 -->
                <div class="board-content mt-4 mb-4" style="white-space: pre-line;">
                    <p th:text="${board.content}"></p>
                </div>

                <!-- 구분선 -->
                <hr style="border: 1px solid #888; margin-bottom: 1rem;">

                <div class="card-footer">
                    <!-- 댓글 제목 -->
                    <h5 id="toggle-comments" style="cursor: pointer; margin-bottom: 1rem; font-size:15px;">
                        댓글
                    </h5>
                    <!-- 댓글 영역 -->
                    <div id="comment-section">
                        <div class="comment-list mt-3">
                            <!-- 서버에서 가져온 댓글이 추가될 곳 -->
                        </div>
                        <form id="commentForm" onsubmit="addComment(event)">
                            <div class="form-group">
                                <textarea
                                        id="comment-content"
                                        class="form-control"
                                        name="content"
                                        rows="4"
                                        maxlength="300"
                                        th:placeholder="${user == null} ? '로그인 후 작성할 수 있습니다.' : '댓글을 입력하세요'"
                                        th:disabled="${user == null}"
                                        required
                                ></textarea>
                                <div style="text-align: right; font-size: 13px;">
                                    <span id="char-count">0</span>/300
                                </div>
                            </div>
                            <div style="display: flex; justify-content: flex-end; margin-top: 10px;">
                                <button type="submit" class="btn btn-sm btn-dark" style="font-size: 14px;" th:if="${user != null}">등록</button>
                            </div>
                        </form>
                    </div>
                </div>
                <input type="hidden" id="boardNo" th:value="${board.boardNo}" />

                <!-- 구분선 -->
                <hr style="border: 1px solid #888; margin-bottom: 1rem;">

                <!-- 목록, 수정, 삭제 버튼 -->
                <div class="d-flex justify-content-between align-items-center mt-3 mb-4">
                    <!-- 목록(왼쪽 정렬) -->
                    <a th:href="@{/boardList(boardCategory=${boardCategory})}" class="btn btn-sm btn-outline-secondary" style="font-size: 14px;">목록</a>
                    <!-- 수정 및 삭제 버튼(오른쪽 정렬) -->
                    <div class="d-flex align-items-center">
                        <!-- 수정  -->
                        <a th:if="${user != null and user.loginId == board.user.loginId}"
                           th:href="@{/boards/editBoard/{boardNo}(boardNo=${board.boardNo})}"
                           class="btn btn-sm btn-outline-secondary" style="font-size: 14px; margin-right: 5px;">수정</a>

                        <!-- 삭제: POST방식을 위해 a 태그에서 독립적인 form으로 변경 -->
                        <form th:if="${user != null and user.loginId == board.user.loginId}"
                              th:action="@{/boards/deleteBoard/{boardNo}(boardNo=${board.boardNo})}"
                              method="post"
                              onsubmit="return confirm('정말 삭제하시겠습니까?');"
                              style="display: inline;">
                            <button type="submit" class="btn btn-sm btn-outline-danger" style="font-size: 14px;">삭제</button>
                        </form>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- 공통 푸터 -->
    <div th:replace="~{common/footer :: footer}"></div>
    <!-- Bootstrap core JS, 자바스크립트 파일을 페이지에 포함 js 파일에 포함(scrips.js)-->
    <!-- 오픈 캔버스를 쓰기 위함, popper.js-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>

        function addComment(event) {
            event.preventDefault(); // 폼의 기본 동작 방지

            // 댓글 입력 값과 게시글 번호 가져오기
            const content = document.querySelector("textarea[name='content']").value.trim(); // 댓글 내용
            const boardNo = document.querySelector("#boardNo").value; // 게시글 번호 (hidden input)

            // 입력 값 검증
            if (!content) {
                alert("댓글을 입력하세요.");
                return;
            }

            // 서버로 보낼 데이터 객체 생성
            const commentData = { boardNo, content };
            console.log("전송 데이터:", commentData);

            // Fetch를 사용하여 서버에 데이터 전송
            fetch("/comment/addComment", {
                method: "POST", // POST 방식으로 데이터 전송
                headers: { "Content-Type": "application/json" }, // JSON 형식 명시
                body: JSON.stringify(commentData), // JSON 문자열(JavaScript 객체)
            })
                .then(response => {
                    if (!response.ok) { // 응답 상태 확인
                        if (response.status === 401) { // 인증이 되지 않은 경우
                            alert("로그인이 필요합니다.");
                            window.location.href = "/users/login"; // 로그인 페이지로 이동
                        }
                         throw new Error(`서버 오류: ${response.status}`);
                    }
                    return response.json(); // JSON 데이터로 변환
                })
                .then(data => {
                    console.log("서버에서 받은 데이터:", data);
                    // function으로 분리하여 간결화
                    updateCommentList(data); // 댓글 리스트 업데이트(새 댓글 추가)
                    clearCommentInput(); // 입력창 초기화
                })
                .catch(error => {
                    console.error("댓글 등록 중 오류:", error.message);
                    alert("댓글 등록 중 문제가 발생했습니다.");
                });
        }

        // 댓글 리스트 업데이트(새 댓글 추가)
        function updateCommentList(data) {
            console.log("서버 응답 데이터:", data); // 데이터 확인

            const commentList = document.querySelector(".comment-list");
            const newComment = document.createElement("div");
            newComment.className = "comment-item";

            // 날짜 포맷
            const commentDate = new Date(data.createDate);
            const now = new Date();
            const isToday = commentDate.toDateString() === now.toDateString();
            const formattedDate = isToday
                ? commentDate.toTimeString().slice(0, 5) // HH:mm
                : commentDate.toISOString().slice(2, 10).replace(/-/g, '.'); // yy.MM.dd

            newComment.innerHTML = `
                <div class="comment-header">
                    <p><strong>${data.nickname}</strong>
                       <span style="font-size: 0.85rem; color: #666;">${formattedDate}</span></p>
                </div>
                <div class="comment-body">
                    <p>${data.content}</p>
                </div>
            `;
            commentList.appendChild(newComment); // 화면에 새 댓글 추가
        }

        // 입력창 초기화
        function clearCommentInput() {
            document.querySelector("textarea[name='content']").value = ""; // 입력창 내용 초기화
        document.getElementById("char-count").textContent = "0"; // 글자 수 초기화

        }

        // 댓글 목록 조회
        function loadComments(boardNo){
            fetch(`/comment/listComment/${boardNo}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`서버 오류: ${response.status}`);
                }
                return response.json(); // JSON 응답을 객체로 변환
            })
            .then(comments => {
                renderComments(comments); // 댓글 렌더링
            })
            .catch(error => {
                console.error("댓글 목록 조회 중 오류:", error.message);
                alert("댓글 목록을 불러오는 중 문제가 발생했습니다.");
            });
        }

        // 댓글 목록을 화면에 렌더링
        function renderComments(comments) {
            const commentList = document.querySelector(".comment-list");
            commentList.innerHTML = ""; // 기존 댓글 목록 초기화

            // 서버에서 가져온 댓글 데이터를 반복하면서 화면에 추가
            comments.forEach(comment => {
                const commentItem = document.createElement("div");
                commentItem.className = "comment-item";

                // 날짜 포맷
                const commentDate = new Date(comment.createDate);
                const now = new Date();
                const isToday = commentDate.toDateString() === now.toDateString();
                const formattedDate = isToday
                    ? commentDate.toTimeString().slice(0, 5) // HH:mm
                    : commentDate.toISOString().slice(2, 10).replace(/-/g, '.'); // yy.MM.dd

                commentItem.innerHTML = `
                    <div class="comment-header">
                        <p><strong>${comment.nickname}</strong>
                           <span style="font-size: 0.85rem; color: #666;">${formattedDate}</span></p>
                    </div>
                    <div class="comment-body">
                        <p>${comment.content}</p>
                    </div>
                `;
                commentList.appendChild(commentItem);
            });
        }

        // 페이지 로드 시 댓글 목록 자동 로드 및 댓글 열고 닫기 로직 추가
        document.addEventListener("DOMContentLoaded", () => {
            const boardNo = document.querySelector("#boardNo").value; // 게시글 번호 가져오기
            loadComments(boardNo); // 댓글 목록 불러오기

            // 댓글 열고 닫기 로직
            const toggleComments = document.getElementById("toggle-comments");
            const commentSection = document.getElementById("comment-section");

            // 초기 상태 (열림)
            let isOpen = true;

            // 댓글 열고 닫기 이벤트
            toggleComments.addEventListener("click", () => {
                isOpen = !isOpen; // 상태 반전
                if (isOpen) {
                    commentSection.style.display = "block"; // 댓글 열기
                } else {
                    commentSection.style.display = "none"; // 댓글 닫기
                }
            });
        });


        // 글자 수 카운트 함수
        document.getElementById("comment-content").addEventListener("input", function () {
            const textarea = this;
            const maxLength = 300; // 최대 글자 수
            const currentLength = textarea.value.length; // 현재 입력된 글자 수

            // 글자 수를 화면에 표시
            document.getElementById("char-count").textContent = currentLength;

            // 글자 초과 시 경고 (선택 사항)
            if (currentLength > maxLength) {
                alert("300자를 초과할 수 없습니다!");
            }
        });
    </script>

    </body>
</html>
